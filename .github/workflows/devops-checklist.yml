name: DevOps Checklist Reminder

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  pull-requests: write
  contents: read

jobs:
  checklist-reminder:
    name: Add DevOps Checklist Reminder
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.base.ref == 'main' || 
      github.event.pull_request.base.ref == 'master'
    
    steps:
      - name: Check if checklist comment exists
        id: check-comment
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
            });
            
            const botComment = comments.data.find(
              comment => comment.user.type === 'Bot' && 
              comment.body.includes('DevOps Checklist')
            );
            
            return { exists: !!botComment, commentId: botComment?.id };
      
      - name: Check if deployment notes comment exists
        id: check-deployment-notes
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
            });
            
            const botComment = comments.data.find(
              comment => comment.user.type === 'Bot' && 
              comment.body.includes('Deployment Notes')
            );
            
            return { exists: !!botComment, commentId: botComment?.id };
      
      - name: Add or update DevOps checklist reminder
        if: steps.check-comment.outputs.exists != 'true' || github.event.action == 'opened'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const checklist = `## üîß DevOps Checklist Reminder
            
            Before merging this PR, please ensure all items are checked:
            
            ### Critical Checks
            - [ ] All CI/CD checks are passing
            - [ ] Code quality checks passed
            - [ ] Security scans completed
            - [ ] Test coverage meets requirements
            - [ ] All reviewers have approved
            
            ### Pre-Release Checks
            - [ ] Version number updated (if applicable)
            - [ ] CHANGELOG.md updated (if applicable)
            - [ ] Breaking changes documented (if any)
            - [ ] Release type identified (Major/Minor/Patch)
            
            ### Deployment Readiness
            - [ ] Deployment release document completed (see Deployment Notes below)
            - [ ] All repositories listed with release numbers
            - [ ] Feature details documented for each repository
            - [ ] Dependencies identified and documented
            - [ ] Database changes identified (if any)
            - [ ] Testing completed and documented
            - [ ] Known issues documented
            - [ ] Contact information provided
            - [ ] Rollback plan prepared
            
            ### Post-Merge (DevOps Team)
            - [ ] Deployment details filled in
            - [ ] Deployment instructions followed
            - [ ] Post-deployment checklist completed
            - [ ] Deployment acknowledged
            
            ---
            **Note:** This is an automated reminder. Please complete the Deployment Notes document below before merging.`;
            
            // Check if comment already exists
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
            });
            
            const existingComment = comments.data.find(
              comment => comment.user.type === 'Bot' && 
              comment.body.includes('DevOps Checklist Reminder') &&
              !comment.body.includes('Deployment Notes')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: checklist
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: checklist
              });
            }
      
      - name: Add or update Deployment Notes
        if: steps.check-deployment-notes.outputs.exists != 'true' || github.event.action == 'opened'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const deploymentNotes = `## üìù Production Deployment Release Document
            
            Please fill out the deployment release document below:
            
            **Release Information:**
            - [ ] Version: \`\`\`<!-- e.g., 4.2.0 -->\`\`\`
            - [ ] Release Date: \`\`\`<!-- e.g., 2025-01-23 -->\`\`\`
            - [ ] Prepared by: \`\`\`<!-- Your name -->\`\`\`
            - [ ] Approved by: \`\`\`<!-- QA/Reviewer names -->\`\`\`
            - [ ] Release Type: \`\`\`<!-- Major / Minor / Patch -->\`\`\`
            
            **Deployment Branches:**
            \`\`\`
            <!-- List deployment branches, e.g., main, master, release/v4.2.0 -->
            \`\`\`
            
            **Overview:**
            \`\`\`
            <!-- Provide key feature details and summary of changes -->
            \`\`\`
            
            **Repository Details:**
            
            | S.No. | Repository Name | Release Number | Feature Details |
            |-------|-----------------|----------------|-----------------|
            | 1. | \`\`\`<!-- repo name -->\`\`\` | \`\`\`<!-- release tag -->\`\`\` | \`\`\`<!-- features -->\`\`\` |
            | 2. | \`\`\`<!-- repo name -->\`\`\` | \`\`\`<!-- release tag -->\`\`\` | \`\`\`<!-- features -->\`\`\` |
            | 3. | \`\`\`<!-- repo name -->\`\`\` | \`\`\`<!-- release tag -->\`\`\` | \`\`\`<!-- features -->\`\`\` |
            
            **Dependencies:**
            - [ ] Dependencies updated: \`Yes\` / \`No\`
            \`\`\`
            <!-- List dependency changes, e.g.:
            - npm i --legacy-peer-deps (new package bcryptjs)
            - Start Server - Check nginx
            -->
            \`\`\`
            
            **Database Changes (Queries to run):**
            - [ ] Database changes required: \`Yes\` / \`No\`
            \`\`\`
            <!-- List SQL queries or migration scripts if applicable -->
            \`\`\`
            
            **Testing:**
            - [ ] Unit tests passed
            - [ ] Integration tests passed
            - [ ] E2E tests passed
            - [ ] Manual testing completed
            \`\`\`
            <!-- Add testing notes and results -->
            \`\`\`
            
            **Known Issues:**
            - [ ] Known issues: \`Yes\` / \`No\`
            \`\`\`
            <!-- List any known issues or N/A -->
            \`\`\`
            
            **Contact Information:**
            - Support Team Email: \`\`\`<!-- email -->\`\`\`
            - Support Team Phone: \`\`\`<!-- phone -->\`\`\`
            
            **Attachments:**
            - [ ] Deployment files attached/committed
            \`\`\`
            <!-- List attached files or N/A -->
            \`\`\`
            
            ---
            
            ### For DevOps Team Use Only
            *(To be filled by the DevOps team after deploying the release)*
            
            **Deployment Details:**
            - Date and time of deployment: \`\`\`<!-- e.g., 23rd Jan 2025 [8:00PM] -->\`\`\`
            - Deployed by: \`\`\`<!-- DevOps team member name -->\`\`\`
            - Deployment Status: \`\`\`<!-- Successful / Failed / In Progress -->\`\`\`
            
            **Deployment Instructions:**
            - [ ] Pre-deployment tasks completed (backups, etc.)
            - [ ] Production environment accessed securely
            - [ ] Latest release pulled from version control
            - [ ] Dependencies installed/updated
            - [ ] Database migrations run (if applicable)
            - [ ] Application services restarted
            - [ ] Deployment monitored and verified
            
            **Rollback Plan:**
            - [ ] Rollback procedure documented
            - [ ] Previous version tag identified: \`\`\`<!-- tag -->\`\`\`
            - [ ] Database rollback scripts prepared (if applicable)
            - [ ] Rollback tested in staging environment
            
            **Post-Deployment Checklist:**
            - [ ] Service availability and response times verified
            - [ ] System resources monitored
            - [ ] Critical user scenarios tested
            - [ ] Data integrity confirmed
            - [ ] Error logs reviewed
            - [ ] Security scans completed
            - [ ] Server and infrastructure health checked
            - [ ] Backup and disaster recovery procedures validated
            
            **Notes:**
            \`\`\`
            <!-- Add any additional deployment notes -->
            \`\`\`
            
            **Acknowledgment:**
            - [ ] Deployment acknowledged and system ready for production use
            
            ---
            **Note:** This is an automated reminder. Please fill out the deployment release document before merging.`;
            
            // Check if comment already exists
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
            });
            
            const existingComment = comments.data.find(
              comment => comment.user.type === 'Bot' && 
              comment.body.includes('Deployment Notes')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: deploymentNotes
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: deploymentNotes
              });
            }

