name: Workflow Notifications

on:
  workflow_run:
    workflows: 
      - "CI"
      - "Quality Checks"
      - "Generate Semantic Release"
      - "Enhanced Security Scan"
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  notify-on-failure:
    name: Notify on Critical Failures
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      (github.event.workflow_run.workflow_id == 'CI' || 
       github.event.workflow_run.workflow_id == 'Quality Checks' ||
       github.event.workflow_run.workflow_id == 'Generate Semantic Release')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get workflow run details
        id: workflow-details
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const run = context.payload.workflow_run;
            const workflowName = run.name;
            const workflowUrl = run.html_url;
            const commitSha = run.head_sha;
            const branch = run.head_branch;
            const actor = run.actor.login;
            
            // Get commit info
            let commitMessage = 'N/A';
            try {
              const { data: commit } = await github.rest.repos.getCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: commitSha
              });
              commitMessage = commit.commit.message.split('\n')[0];
            } catch (e) {
              console.log('Could not fetch commit details:', e);
            }
            
            // Find associated PR
            let prNumber = null;
            try {
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${branch}`,
                state: 'open'
              });
              if (prs.length > 0) {
                prNumber = prs[0].number;
              }
            } catch (e) {
              console.log('Could not find PR:', e);
            }
            
            const details = {
              workflowName,
              workflowUrl,
              commitSha: commitSha.substring(0, 7),
              branch,
              actor,
              commitMessage,
              prNumber: prNumber ? prNumber.toString() : ''
            };
            
            // Use coreModule to avoid conflicts with github-script's core
            const coreModule = require('@actions/core');
            coreModule.setOutput('details', JSON.stringify(details));
            
            return details;
      
      - name: Create issue for critical failure
        if: always() && steps.workflow-details.outcome == 'success'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const details = JSON.parse('${{ steps.workflow-details.outputs.details }}');
            
            // Skip if PR exists
            if (details.prNumber && details.prNumber !== '') {
              console.log(`PR #${details.prNumber} exists, skipping issue creation`);
              return;
            }
            
            const title = `ðŸš¨ Workflow Failure: ${details.workflowName}`;
            const body = `## Workflow Failure Alert
            
            **Workflow:** ${details.workflowName}
            **Branch:** \`${details.branch}\`
            **Commit:** ${details.commitSha}
            **Triggered by:** @${details.actor}
            **Commit Message:** ${details.commitMessage}
            
            ### Details
            - [View failed workflow run](${details.workflowUrl})
            - Branch: \`${details.branch}\`
            - Commit SHA: \`${details.commitSha}\`
            
            ### Next Steps
            - [ ] Review the workflow logs
            - [ ] Identify the root cause
            - [ ] Fix the issue
            - [ ] Re-run the workflow
            
            ---
            *This issue was automatically created by the workflow notification system.*`;
            
            // Check if issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'workflow-failure'
            });
            
            const existingIssue = issues.find(issue => 
              issue.title.includes(details.workflowName) &&
              issue.body.includes(details.commitSha)
            );
            
            if (existingIssue) {
              console.log(`Issue already exists: #${existingIssue.number}`);
              return;
            }
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['workflow-failure', 'bug', 'ci']
            });
      
      - name: Comment on PR
        if: always() && steps.workflow-details.outcome == 'success'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const details = JSON.parse('${{ steps.workflow-details.outputs.details }}');
            
            // Skip if no PR
            if (!details.prNumber || details.prNumber === '') {
              console.log('No PR found, skipping PR comment');
              return;
            }
            
            const run = context.payload.workflow_run;
            
            const comment = `## ðŸš¨ Workflow Failure Detected
            
            **Workflow:** ${details.workflowName}
            **Status:** âŒ Failed
            **Commit:** ${details.commitSha}
            
            ### Details
            - [View failed workflow run](${details.workflowUrl})
            - Triggered by: @${details.actor}
            
            Please review the workflow logs and fix any issues before merging.
            
            ---
            *This notification was automatically generated.*`;
            
            // Check if comment already exists
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(details.prNumber)
            });
            
            const existingComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Workflow Failure Detected') &&
              comment.body.includes(details.workflowName)
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(details.prNumber),
                body: comment
              });
            }
      
      - name: Send Slack notification (optional)
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          details='${{ steps.workflow-details.outputs.details }}'
          workflow_name=$(echo $details | jq -r '.workflowName')
          workflow_url=$(echo $details | jq -r '.workflowUrl')
          branch=$(echo $details | jq -r '.branch')
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ðŸš¨ Workflow Failure: $workflow_name on branch $branch. <$workflow_url|View Details>\"}" \
            $SLACK_WEBHOOK_URL || echo "Slack notification failed (webhook may not be configured)"

  notify-on-success:
    name: Notify on Release Success
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.workflow_id == 'Generate Semantic Release'
    
    steps:
      - name: Check for new release
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const run = context.payload.workflow_run;
            const branch = run.head_branch;
            
            // Get latest release
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });
            
            if (releases.length === 0) {
              console.log('No releases found');
              return;
            }
            
            const latestRelease = releases[0];
            const releaseDate = new Date(latestRelease.created_at);
            const now = new Date();
            const diffMinutes = (now - releaseDate) / (1000 * 60);
            
            // Only notify if release was created in the last 10 minutes
            if (diffMinutes > 10) {
              console.log('Release is older than 10 minutes, skipping notification');
              return;
            }
            
            const notification = `## ðŸŽ‰ New Release Created!
            
            **Version:** ${latestRelease.tag_name}
            **Name:** ${latestRelease.name || latestRelease.tag_name}
            **Published:** ${releaseDate.toLocaleString()}
            
            ${latestRelease.body ? `### Release Notes\n\n${latestRelease.body.substring(0, 500)}${latestRelease.body.length > 500 ? '...' : ''}\n\n` : ''}
            [View Release](${latestRelease.html_url}) | [Download Assets](${latestRelease.html_url})
            
            ---
            *This notification was automatically generated.*`;
            
            // Try to find associated PR
            try {
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${branch}`,
                state: 'all',
                per_page: 1
              });
              
              if (prs.length > 0) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prs[0].number,
                  body: notification
                });
              }
            } catch (e) {
              console.log('Could not post to PR:', e);
            }
            
            console.log('Release notification generated');

